USE [SocialChimishod]
GO
/****** Object:  Trigger [dbo].[after_update_quest_score_of_player]    Script Date: 2/18/2018 12:55:14 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--— =============================================
--— Author:    <Jeb,JavadBorhani>
--— Create date: <Now I mean Now>
--— Description:  <trigger to update table>
--— =============================================
ALTER TRIGGER [dbo].[after_update_quest_score_of_player]
   ON  [dbo].[UserQuestAnswers]
   after Delete , insert
AS 
BEGIN
	
	INSERT INTO [QuestScore] (UserID, QuestNumber)
	SELECT  UserID, QuestNumber from inserted I 
	EXCEPT
	SELECT  UserID , QuestNumber from [QuestScore]

	Update 
	[dbo].[QuestScore]
	Set 
		Score = 0 + Score + 
		(
		Select SUM(Point)
		From inserted I 
		Where I.UserID = [dbo].[QuestScore].UserID And I.QuestNumber = [dbo].[QuestScore].QuestNumber
		)
	Where 
			UserID IN (Select UserID from inserted)
		And 
			QuestNumber IN (Select QuestNumber from inserted)

	Update 
	[dbo].[QuestScore]
	Set 
		Score = 0 + Score -
		(
		Select SUM(Point)
		From deleted I 
		Where I.UserID = [dbo].[QuestScore].UserID And I.QuestNumber = [dbo].[QuestScore].QuestNumber
		)
	Where 
			UserID IN (Select UserID from deleted)
		And 
			QuestNumber IN (Select QuestNumber from deleted)

END
